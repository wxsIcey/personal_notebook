
# 算子注册相关内容

## forward_oot的调用流程（以AscendDeepseekScalingRotaryEmbedding为例）

1. 注册阶段
首先将类注册到 CustomOp.op_registry_oot 中，比如将AscendDeepseekScalingRotaryEmbedding注册名称为 "DeepseekScalingRotaryEmbedding";

2. 实例化阶段
当实例化时，op_instance = DeepseekScalingRotaryEmbedding()，会调用DeepseekScalingRotaryEmbedding.__new__ 方法，因为DeepseekScalingRotaryEmbedding继承自CustomOp，则会进入CustomOp.__new__ 方法，之后op_cls_to_instantiate=AscendDeepseekScalingRotaryEmbedding，并返回AscendDeepseekScalingRotaryEmbedding的实例

3. 初始化阶段
调用AscendDeepseekScalingRotaryEmbedding的初始化方法，进入CustomOp.__init__ 方法中，调用 self.dispatch_forward() 方法，选择合适的 forward 实现，根据当前硬件平台选择合适的 forward 方法，如果当前平台是 OOT 平台（current_platform.is_out_of_tree() 返回 True），则返回 forward_oot 方法。

4. 调用 forward方法
调用CustomOp.forward 方法，即初始化阶段返回的forward_oot 方法。
注意由于AscendDeepseekScalingRotaryEmbedding类重写了forward方法，所以就不会走第5步，而是直接实现了AscendDeepseekScalingRotaryEmbedding的forward方法。

5. 调用forward_oot方法
def forward_oot(self, *args, **kwargs):
    return self.forward_native(*args,**kwargs)

如果 AscendDeepseekScalingRotaryEmbedding 没有覆盖 forward_oot 方法，则调用 CustomOp.forward_oot 的默认实现, 如果 AscendDeepseekScalingRotaryEmbedding 覆盖了 forward_oot 方法，则调用覆盖后的实现。假设如果AscendDeepseekScalingRotaryEmbedding类中写的不是forward方法而是forward_oot方法呢？这个时候走的是DeepseekScalingRotaryEmbedding的forward方法。
